apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: vcluster-test-onepassword-token
  namespace: vcluster-test
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: onepassword-store
    kind: ClusterSecretStore
  target:
    name: vcluster-test-onepassword-token
    creationPolicy: Owner
  data:
    - secretKey: token
      remoteRef:
        key: onepassword-access-token
        property: credential
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vcluster-test-kubeconfig-sync
  namespace: vcluster-test
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vcluster-test-kubeconfig-reader
  namespace: vcluster-test
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["vc-vcluster-test"]
    verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vcluster-test-kubeconfig-sync
  namespace: vcluster-test
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: vcluster-test-kubeconfig-reader
subjects:
  - kind: ServiceAccount
    name: vcluster-test-kubeconfig-sync
    namespace: vcluster-test
---
apiVersion: batch/v1
kind: Job
metadata:
  name: vcluster-test-kubeconfig-sync
  namespace: vcluster-test
  labels:
    app: vcluster
    instance: test
    component: kubeconfig-sync
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: vcluster
        instance: test
    spec:
      serviceAccountName: vcluster-test-kubeconfig-sync
      restartPolicy: OnFailure
      initContainers:
        # Wait for vcluster kubeconfig secret to be created
        - name: wait-for-kubeconfig
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              echo "Waiting for vcluster kubeconfig secret vc-test..."
              until kubectl get secret vc-vcluster-test -n vcluster-test 2>/dev/null; do
                echo "Secret not found, waiting..."
                sleep 10
              done
              echo "Secret found!"
        # Wait for 1Password token secret to be synced
        - name: wait-for-token
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              echo "Waiting for 1Password Connect token secret..."
              until kubectl get secret vcluster-test-onepassword-token -n vcluster-test 2>/dev/null; do
                echo "Token secret not found, waiting..."
                sleep 10
              done
              echo "Token secret ready!"
      containers:
        - name: sync-to-onepassword
          image: 1password/op:2
          env:
            - name: OP_CONNECT_HOST
              value: "https://connect.integratn.tech"
            - name: OP_CONNECT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: vcluster-test-onepassword-token
                  key: token
            - name: NAMESPACE
              value: "vcluster-test"
            - name: VCLUSTER_NAME
              value: "test"
            - name: OP_ITEM_NAME
              value: "vcluster-test-kubeconfig"
          command:
            - /bin/sh
            - -c
            - |
              set -e
              
              # Get kubeconfig from vcluster secret
              KUBECONFIG_B64=$(kubectl get secret vc-vcluster-${VCLUSTER_NAME} -n ${NAMESPACE} -o jsonpath='{.data.config}')
              KUBECONFIG_CONTENT=$(echo "$KUBECONFIG_B64" | base64 -d)
              
              # Create or update 1Password item
              echo "Syncing kubeconfig to 1Password item: ${OP_ITEM_NAME}"
              
              # Check if item exists
              if op item get "${OP_ITEM_NAME}" --vault "homelab" 2>/dev/null; then
                echo "Item exists, updating..."
                op item edit "${OP_ITEM_NAME}" --vault "homelab" kubeconfig="${KUBECONFIG_CONTENT}"
              else
                echo "Item does not exist, creating..."
                op item create --category=SecureNote --title="${OP_ITEM_NAME}" --vault="homelab" kubeconfig="${KUBECONFIG_CONTENT}"
              fi
              
              echo "Kubeconfig synced successfully to 1Password"
