apiVersion: batch/v1
kind: Job
metadata:
  labels:
    app.kubernetes.io/managed-by: kratix
    app.kubernetes.io/name: kubeconfig-sync
    kratix.io/promise-name: vcluster-orchestrator-v2
    kratix.io/resource-name: vcluster-media
  name: vcluster-vcluster-media-kubeconfig-sync
  namespace: vcluster-media
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: vcluster-media
        app.kubernetes.io/name: kubeconfig-sync
    spec:
      containers:
      - command:
        - sh
        - -c
        - |-
          set -e

          apk add --no-cache curl jq >/dev/null 2>&1

          echo "=== VCluster Kubeconfig Sync to 1Password ==="
          echo "VCluster: $VCLUSTER_NAME"
          echo "1Password Item: $OP_ITEM_NAME"
          echo "Vault: $OP_VAULT"

          # Read kubeconfig from secret
          KUBECONFIG_CONTENT=$(cat /kubeconfig/config)

          # Build ArgoCD cluster config
          ARGOCD_CONFIG=$(cat <<EOF
          {
            "tlsClientConfig": {
              "insecure": false
            }
          }
          EOF
          )

          # Check if item exists
          echo "Checking if item exists..."
          ITEM_SEARCH=$(curl -s -X POST "$OP_CONNECT_HOST/v1/vaults/homelab/items" \
            -H "Authorization: Bearer $OP_CONNECT_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"title\":\"$OP_ITEM_NAME\"}" || echo "{}")

          ITEM_ID=$(echo "$ITEM_SEARCH" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4 || echo "")

          if [ -z "$ITEM_ID" ]; then
            echo "Creating new 1Password item..."
            RESPONSE=$(curl -s -X POST "$OP_CONNECT_HOST/v1/vaults/homelab/items" \
              -H "Authorization: Bearer $OP_CONNECT_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"title\": \"$OP_ITEM_NAME\",
                \"category\": \"SERVER\",
                \"tags\": [\"vcluster\", \"kubeconfig\", \"$ARGOCD_ENVIRONMENT\"],
                \"fields\": [
                  {
                    \"id\": \"kubeconfig\",
                    \"type\": \"CONCEALED\",
                    \"label\": \"kubeconfig\",
                    \"value\": $(echo \"$KUBECONFIG_CONTENT\" | jq -Rs .)
                  },
                  {
                    \"id\": \"argocd-name\",
                    \"type\": \"STRING\",
                    \"label\": \"argocd-name\",
                    \"value\": \"$VCLUSTER_NAME.$BASE_DOMAIN_SANITIZED\"
                  },
                  {
                    \"id\": \"argocd-server\",
                    \"type\": \"STRING\",
                    \"label\": \"argocd-server\",
                    \"value\": \"$EXTERNAL_SERVER_URL\"
                  },
                  {
                    \"id\": \"argocd-config\",
                    \"type\": \"CONCEALED\",
                    \"label\": \"argocd-config\",
                    \"value\": $(echo \"$ARGOCD_CONFIG\" | jq -Rc .)
                  }
                ]
              }")
            ITEM_ID=$(echo "$RESPONSE" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)
            echo "Created item with ID: $ITEM_ID"
          else
            echo "Updating existing item ID: $ITEM_ID"
            curl -s -X PATCH "$OP_CONNECT_HOST/v1/vaults/homelab/items/$ITEM_ID" \
              -H "Authorization: Bearer $OP_CONNECT_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"fields\": [
                  {
                    \"id\": \"kubeconfig\",
                    \"value\": $(echo \"$KUBECONFIG_CONTENT\" | jq -Rs .)
                  },
                  {
                    \"id\": \"argocd-name\",
                    \"value\": \"$VCLUSTER_NAME.$BASE_DOMAIN_SANITIZED\"
                  },
                  {
                    \"id\": \"argocd-server\",
                    \"value\": \"$EXTERNAL_SERVER_URL\"
                  },
                  {
                    \"id\": \"argocd-config\",
                    \"value\": $(echo \"$ARGOCD_CONFIG\" | jq -Rc .)
                  }
                ]
              }"
          fi

          echo "âœ“ Kubeconfig synced to 1Password successfully"
        env:
        - name: OP_CONNECT_HOST
          value: https://connect.integratn.tech
        - name: OP_CONNECT_TOKEN
          valueFrom:
            secretKeyRef:
              key: token
              name: vcluster-vcluster-media-onepassword-token
        - name: OP_VAULT
          valueFrom:
            secretKeyRef:
              key: vault
              name: vcluster-vcluster-media-onepassword-token
        - name: VCLUSTER_NAME
          value: vcluster-media
        - name: OP_ITEM_NAME
          value: vcluster-vcluster-media-kubeconfig
        - name: BASE_DOMAIN
          value: integratn.tech
        - name: BASE_DOMAIN_SANITIZED
          value: integratn-tech
        - name: EXTERNAL_SERVER_URL
          value: https://media.integratn.tech:443
        - name: ARGOCD_ENVIRONMENT
          value: production
        image: alpine:3.20
        name: sync-to-onepassword
        volumeMounts:
        - mountPath: /kubeconfig
          name: kubeconfig
          readOnly: true
      initContainers:
      - command:
        - sh
        - -c
        - |-
          echo "Waiting for secret vc-vcluster-media to exist..."
          until [ -f /kubeconfig/config ]; do
            echo "Kubeconfig not found yet, sleeping..."
            sleep 5
          done
          echo "Kubeconfig found!"
        image: busybox:1.36
        name: wait-for-kubeconfig
        volumeMounts:
        - mountPath: /kubeconfig
          name: kubeconfig
      restartPolicy: OnFailure
      serviceAccountName: vcluster-media-kubeconfig-sync
      volumes:
      - name: kubeconfig
        secret:
          optional: false
          secretName: vc-vcluster-media
  ttlSecondsAfterFinished: 600
