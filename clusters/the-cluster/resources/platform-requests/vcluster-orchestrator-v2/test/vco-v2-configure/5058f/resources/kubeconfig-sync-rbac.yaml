---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: test-onepassword-token
  namespace: vcluster-test
  labels:
    app.kubernetes.io/name: external-secret
    app.kubernetes.io/component: kubeconfig-sync
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: vcluster-orchestrator-v2
    kratix.io/resource-name: test
spec:
  secretStoreRef:
    name: onepassword-store
    kind: ClusterSecretStore
  target:
    name: vcluster-test-onepassword-token
  data:
    - secretKey: token
      remoteRef:
        key: onepassword-access-token
        property: credential
    - secretKey: vault
      remoteRef:
        key: onepassword-access-token
        property: vault
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: test-kubeconfig-sync
  namespace: vcluster-test
  labels:
    app.kubernetes.io/name: kubeconfig-sync
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: vcluster-orchestrator-v2
    kratix.io/resource-name: test
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: test-kubeconfig-sync
  namespace: vcluster-test
  labels:
    app.kubernetes.io/name: kubeconfig-sync
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: vcluster-orchestrator-v2
    kratix.io/resource-name: test
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["vc-test", "vcluster-test-onepassword-token"]
    verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: test-kubeconfig-sync
  namespace: vcluster-test
  labels:
    app.kubernetes.io/name: kubeconfig-sync
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: vcluster-orchestrator-v2
    kratix.io/resource-name: test
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: test-kubeconfig-sync
subjects:
  - kind: ServiceAccount
    name: test-kubeconfig-sync
    namespace: vcluster-test
