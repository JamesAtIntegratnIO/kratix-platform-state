apiVersion: batch/v1
kind: Job
metadata:
  name: vcluster-test-kubeconfig-sync
  namespace: vcluster-test
  labels:
    app.kubernetes.io/name: kubeconfig-sync
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: vcluster-orchestrator-v2
    kratix.io/resource-name: test
  annotations:
    argocd.argoproj.io/hook: Skip
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kubeconfig-sync
        app.kubernetes.io/instance: test
    spec:
      serviceAccountName: test-kubeconfig-sync
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-kubeconfig
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for secret vc-test to exist..."
              until [ -f /kubeconfig/config ]; do
                echo "Kubeconfig not found yet, sleeping..."
                sleep 5
              done
              echo "Kubeconfig found!"
          volumeMounts:
            - name: kubeconfig
              mountPath: /kubeconfig
      containers:
        - name: sync-to-onepassword
          image: curlimages/curl:8.5.0
          env:
            - name: OP_CONNECT_HOST
              value: "http://onepassword-connect.onepassword.svc.cluster.local:8080"
            - name: OP_CONNECT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: test-onepassword-token
                  key: token
            - name: VCLUSTER_NAME
              value: "test"
            - name: OP_ITEM_NAME
              value: "vcluster-test-kubeconfig"
            - name: OP_VAULT
              value: "homelab"
            - name: BASE_DOMAIN
              value: "integratn.tech"
            - name: BASE_DOMAIN_SANITIZED
              value: "integratn-tech"
            - name: EXTERNAL_SERVER_URL
              value: "https://test.integratn.tech:443"
            - name: ARGOCD_ENVIRONMENT
              value: "development"
          command:
            - sh
            - -c
            - |
              set -e
              
              echo "=== VCluster Kubeconfig Sync to 1Password ==="
              echo "VCluster: $VCLUSTER_NAME"
              echo "1Password Item: $OP_ITEM_NAME"
              echo "Vault: $OP_VAULT"
              
              # Read kubeconfig from secret
              KUBECONFIG_CONTENT=$(cat /kubeconfig/config)
              
              # Build ArgoCD cluster config
              ARGOCD_CONFIG=$(cat <<EOF
              {
                "tlsClientConfig": {
                  "insecure": false
                }
              }
              EOF
              )
              
              # Check if item exists
              echo "Checking if item exists..."
              ITEM_SEARCH=$(curl -s -X POST "$OP_CONNECT_HOST/v1/vaults/homelab/items" \
                -H "Authorization: Bearer $OP_CONNECT_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"title\":\"$OP_ITEM_NAME\"}" || echo "{}")
              
              ITEM_ID=$(echo "$ITEM_SEARCH" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4 || echo "")
              
              if [ -z "$ITEM_ID" ]; then
                echo "Creating new 1Password item..."
                RESPONSE=$(curl -s -X POST "$OP_CONNECT_HOST/v1/vaults/homelab/items" \
                  -H "Authorization: Bearer $OP_CONNECT_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d "{
                    \"title\": \"$OP_ITEM_NAME\",
                    \"category\": \"SERVER\",
                    \"tags\": [\"vcluster\", \"kubeconfig\", \"$ARGOCD_ENVIRONMENT\"],
                    \"fields\": [
                      {
                        \"id\": \"kubeconfig\",
                        \"type\": \"CONCEALED\",
                        \"label\": \"kubeconfig\",
                        \"value\": $(echo "$KUBECONFIG_CONTENT" | jq -Rs .)
                      },
                      {
                        \"id\": \"argocd-name\",
                        \"type\": \"STRING\",
                        \"label\": \"argocd-name\",
                        \"value\": \"$VCLUSTER_NAME.$BASE_DOMAIN_SANITIZED\"
                      },
                      {
                        \"id\": \"argocd-server\",
                        \"type\": \"STRING\",
                        \"label\": \"argocd-server\",
                        \"value\": \"$EXTERNAL_SERVER_URL\"
                      },
                      {
                        \"id\": \"argocd-config\",
                        \"type\": \"CONCEALED\",
                        \"label\": \"argocd-config\",
                        \"value\": $(echo "$ARGOCD_CONFIG" | jq -Rc .)
                      }
                    ]
                  }")
                ITEM_ID=$(echo "$RESPONSE" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)
                echo "Created item with ID: $ITEM_ID"
              else
                echo "Updating existing item ID: $ITEM_ID"
                curl -s -X PATCH "$OP_CONNECT_HOST/v1/vaults/homelab/items/$ITEM_ID" \
                  -H "Authorization: Bearer $OP_CONNECT_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d "{
                    \"fields\": [
                      {
                        \"id\": \"kubeconfig\",
                        \"value\": $(echo "$KUBECONFIG_CONTENT" | jq -Rs .)
                      },
                      {
                        \"id\": \"argocd-name\",
                        \"value\": \"$VCLUSTER_NAME.$BASE_DOMAIN_SANITIZED\"
                      },
                      {
                        \"id\": \"argocd-server\",
                        \"value\": \"$EXTERNAL_SERVER_URL\"
                      },
                      {
                        \"id\": \"argocd-config\",
                        \"value\": $(echo "$ARGOCD_CONFIG" | jq -Rc .)
                      }
                    ]
                  }"
              fi
              
              echo "âœ“ Kubeconfig synced to 1Password successfully"
          volumeMounts:
            - name: kubeconfig
              mountPath: /kubeconfig
              readOnly: true
      volumes:
        - name: kubeconfig
          secret:
            secretName: vc-test
            optional: false
