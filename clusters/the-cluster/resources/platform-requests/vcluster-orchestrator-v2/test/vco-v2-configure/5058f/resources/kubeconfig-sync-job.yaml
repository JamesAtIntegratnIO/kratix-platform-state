apiVersion: batch/v1
kind: Job
metadata:
  labels:
    app.kubernetes.io/managed-by: kratix
    app.kubernetes.io/name: kubeconfig-sync
    kratix.io/promise-name: vcluster-orchestrator-v2
    kratix.io/resource-name: test
  name: vcluster-test-kubeconfig-sync
  namespace: vcluster-test
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: test
        app.kubernetes.io/name: kubeconfig-sync
    spec:
      containers:
      - command:
        - sh
        - -c
        - "set -e\n\napk add --no-cache curl jq >/dev/null 2>&1\n\necho \"=== VCluster
          Kubeconfig Sync to 1Password ===\"\necho \"VCluster: $VCLUSTER_NAME\"\necho
          \"1Password Item: $OP_ITEM_NAME\"\necho \"Vault: $OP_VAULT\"\n\nOP_CONNECT_HOST_CLEAN=$(printf
          '%s' \"$OP_CONNECT_HOST\" | tr -d '\\r\\n')\nOP_CONNECT_TOKEN_CLEAN=$(printf
          '%s' \"$OP_CONNECT_TOKEN\" | tr -d '\\r\\n')\nAPI_BASE=\"${OP_CONNECT_HOST_CLEAN%/}/v1\"\nAUTH_HEADER=\"Authorization:
          Bearer ${OP_CONNECT_TOKEN_CLEAN}\"\n\nVAULT_ID=\"${OP_VAULT:-}\"\nVAULT_ID=$(printf
          '%s' \"$VAULT_ID\" | tr -d '\\r\\n')\nif [ -z \"$VAULT_ID\" ]; then\n\tVAULT_ID=$(curl
          -fsS -H \"$AUTH_HEADER\" \"$API_BASE/vaults\" | jq -r --arg name \"homelab\"
          '.[] | select(.name==$name) | .id' | head -n1)\nfi\nVAULT_ID=$(printf '%s'
          \"$VAULT_ID\" | tr -d '\\r\\n')\nif [ -z \"$VAULT_ID\" ]; then\n\techo \"Vault
          not found: homelab\"\n\texit 1\nfi\n\n# Read kubeconfig from secret\nKUBECONFIG_CONTENT=$(cat
          /kubeconfig/config)\n\n# Extract TLS data from kubeconfig for ArgoCD cluster
          config\nCA_DATA=$(grep 'certificate-authority-data:' /kubeconfig/config
          | awk '{print $2}' | tr -d '\\r\\n' | head -n1)\nCLIENT_CERT=$(grep 'client-certificate-data:'
          /kubeconfig/config | awk '{print $2}' | tr -d '\\r\\n' | head -n1)\nCLIENT_KEY=$(grep
          'client-key-data:' /kubeconfig/config | awk '{print $2}' | tr -d '\\r\\n'
          | head -n1)\n\n# Build ArgoCD cluster config with TLS client certificates\nif
          [ -n \"$CA_DATA\" ] && [ -n \"$CLIENT_CERT\" ] && [ -n \"$CLIENT_KEY\" ];
          then\n  ARGOCD_CONFIG=$(printf '{\"tlsClientConfig\":{\"insecure\":false,\"caData\":\"%s\",\"certData\":\"%s\",\"keyData\":\"%s\"}}'
          \"$CA_DATA\" \"$CLIENT_CERT\" \"$CLIENT_KEY\")\n  echo \"ArgoCD config built
          with TLS certs (caData=${#CA_DATA} chars, certData=${#CLIENT_CERT} chars,
          keyData=${#CLIENT_KEY} chars)\"\nelse\n  echo \"WARNING: Could not extract
          TLS data from kubeconfig, falling back to insecure\"\n  ARGOCD_CONFIG='{\"tlsClientConfig\":{\"insecure\":true}}'\nfi\n\n#
          Check if item exists\necho \"Checking if item exists...\"\nITEM_ID=$(curl
          -fsS -H \"$AUTH_HEADER\" \"$API_BASE/vaults/$VAULT_ID/items\" | jq -r --arg
          title \"$OP_ITEM_NAME\" '.[] | select(.title==$title) | .id' | head -n1)\n\nif
          [ -z \"$ITEM_ID\" ]; then\n  echo \"Creating new 1Password item...\"\n  RESPONSE=$(curl
          -sS -w \"\\n%{http_code}\" -X POST \"$API_BASE/vaults/$VAULT_ID/items\"
          \\\n    -H \"$AUTH_HEADER\" \\\n    -H \"Content-Type: application/json\"
          \\\n    -d \"{\n      \\\"title\\\": \\\"$OP_ITEM_NAME\\\",\n      \\\"vault\\\":
          {\\\"id\\\": \\\"$VAULT_ID\\\"},\n      \\\"category\\\": \\\"SERVER\\\",\n
          \     \\\"tags\\\": [\\\"vcluster\\\", \\\"kubeconfig\\\", \\\"$ARGOCD_ENVIRONMENT\\\"],\n
          \     \\\"fields\\\": [\n        {\n          \\\"id\\\": \\\"kubeconfig\\\",\n
          \         \\\"type\\\": \\\"CONCEALED\\\",\n          \\\"label\\\": \\\"kubeconfig\\\",\n
          \         \\\"value\\\": $(printf '%s' \"$KUBECONFIG_CONTENT\" | jq -Rs
          .)\n        },\n        {\n          \\\"id\\\": \\\"argocd-name\\\",\n
          \         \\\"type\\\": \\\"STRING\\\",\n          \\\"label\\\": \\\"argocd-name\\\",\n
          \         \\\"value\\\": \\\"$VCLUSTER_NAME.$BASE_DOMAIN_SANITIZED\\\"\n
          \       },\n        {\n          \\\"id\\\": \\\"argocd-server\\\",\n          \\\"type\\\":
          \\\"STRING\\\",\n          \\\"label\\\": \\\"argocd-server\\\",\n          \\\"value\\\":
          \\\"$EXTERNAL_SERVER_URL\\\"\n        },\n        {\n          \\\"id\\\":
          \\\"argocd-config\\\",\n          \\\"type\\\": \\\"CONCEALED\\\",\n          \\\"label\\\":
          \\\"argocd-config\\\",\n          \\\"value\\\": $(printf '%s' \"$ARGOCD_CONFIG\"
          | jq -Rc .)\n        }\n      ]\n    }\")\n  HTTP_STATUS=$(echo \"$RESPONSE\"
          | tail -n1)\n  BODY=$(echo \"$RESPONSE\" | sed '$d')\n  if [ \"$HTTP_STATUS\"
          -ge 400 ]; then\n    echo \"Failed to create 1Password item (HTTP $HTTP_STATUS):
          $BODY\"\n    exit 1\n  fi\n  ITEM_ID=$(echo \"$BODY\" | jq -r '.id')\n  if
          [ -z \"$ITEM_ID\" ] || [ \"$ITEM_ID\" = \"null\" ]; then\n    echo \"Failed
          to extract item ID from response\"\n    exit 1\n  fi\n  echo \"Created item
          with ID: $ITEM_ID\"\nelse\n  echo \"Updating existing item ID: $ITEM_ID\"\n
          \ RESPONSE=$(curl -sS -w \"\\n%{http_code}\" -X PUT \"$API_BASE/vaults/$VAULT_ID/items/$ITEM_ID\"
          \\\n    -H \"$AUTH_HEADER\" \\\n    -H \"Content-Type: application/json\"
          \\\n    -d \"{\n      \\\"id\\\": \\\"$ITEM_ID\\\",\n      \\\"title\\\":
          \\\"$OP_ITEM_NAME\\\",\n      \\\"vault\\\": {\\\"id\\\": \\\"$VAULT_ID\\\"},\n
          \     \\\"category\\\": \\\"SERVER\\\",\n      \\\"tags\\\": [\\\"vcluster\\\",
          \\\"kubeconfig\\\", \\\"$ARGOCD_ENVIRONMENT\\\"],\n      \\\"fields\\\":
          [\n        {\n          \\\"id\\\": \\\"kubeconfig\\\",\n          \\\"type\\\":
          \\\"CONCEALED\\\",\n          \\\"label\\\": \\\"kubeconfig\\\",\n          \\\"value\\\":
          $(printf '%s' \"$KUBECONFIG_CONTENT\" | jq -Rs .)\n        },\n        {\n
          \         \\\"id\\\": \\\"argocd-name\\\",\n          \\\"type\\\": \\\"STRING\\\",\n
          \         \\\"label\\\": \\\"argocd-name\\\",\n          \\\"value\\\":
          \\\"$VCLUSTER_NAME.$BASE_DOMAIN_SANITIZED\\\"\n        },\n        {\n          \\\"id\\\":
          \\\"argocd-server\\\",\n          \\\"type\\\": \\\"STRING\\\",\n          \\\"label\\\":
          \\\"argocd-server\\\",\n          \\\"value\\\": \\\"$EXTERNAL_SERVER_URL\\\"\n
          \       },\n        {\n          \\\"id\\\": \\\"argocd-config\\\",\n          \\\"type\\\":
          \\\"CONCEALED\\\",\n          \\\"label\\\": \\\"argocd-config\\\",\n          \\\"value\\\":
          $(printf '%s' \"$ARGOCD_CONFIG\" | jq -Rc .)\n        }\n      ]\n    }\")\n
          \ HTTP_STATUS=$(echo \"$RESPONSE\" | tail -n1)\n  BODY=$(echo \"$RESPONSE\"
          | sed '$d')\n  if [ \"$HTTP_STATUS\" -ge 400 ]; then\n    echo \"Failed
          to update 1Password item (HTTP $HTTP_STATUS): $BODY\"\n    exit 1\n  fi\n
          \ echo \"Updated item successfully\"\nfi\n\necho \"âœ“ Kubeconfig synced to
          1Password successfully\""
        env:
        - name: OP_CONNECT_HOST
          value: https://connect.integratn.tech
        - name: OP_CONNECT_TOKEN
          valueFrom:
            secretKeyRef:
              key: token
              name: vcluster-test-onepassword-token
        - name: OP_VAULT
          valueFrom:
            secretKeyRef:
              key: vault
              name: vcluster-test-onepassword-token
        - name: VCLUSTER_NAME
          value: test
        - name: OP_ITEM_NAME
          value: vcluster-test-kubeconfig
        - name: BASE_DOMAIN
          value: integratn.tech
        - name: BASE_DOMAIN_SANITIZED
          value: integratn-tech
        - name: EXTERNAL_SERVER_URL
          value: https://test.integratn.tech:443
        - name: ARGOCD_ENVIRONMENT
          value: development
        image: alpine:3.20
        name: sync-to-onepassword
        volumeMounts:
        - mountPath: /kubeconfig
          name: kubeconfig
          readOnly: true
      initContainers:
      - command:
        - sh
        - -c
        - |-
          echo "Waiting for secret vc-test to exist..."
          until [ -f /kubeconfig/config ]; do
            echo "Kubeconfig not found yet, sleeping..."
            sleep 5
          done
          echo "Kubeconfig found!"
        image: busybox:1.36
        name: wait-for-kubeconfig
        volumeMounts:
        - mountPath: /kubeconfig
          name: kubeconfig
      restartPolicy: OnFailure
      serviceAccountName: test-kubeconfig-sync
      volumes:
      - name: kubeconfig
        secret:
          optional: false
          secretName: vc-test
  ttlSecondsAfterFinished: 600
