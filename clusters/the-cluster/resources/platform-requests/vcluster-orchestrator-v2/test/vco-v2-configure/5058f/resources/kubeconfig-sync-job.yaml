apiVersion: batch/v1
kind: Job
metadata:
  labels:
    app.kubernetes.io/managed-by: kratix
    app.kubernetes.io/name: kubeconfig-sync
    kratix.io/promise-name: vcluster-orchestrator-v2
    kratix.io/resource-name: test
  name: vcluster-test-kubeconfig-sync
  namespace: vcluster-test
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: test
        app.kubernetes.io/name: kubeconfig-sync
    spec:
      containers:
      - command:
        - sh
        - -c
        - "set -e\n\napk add --no-cache curl jq >/dev/null 2>&1\n\necho \"=== VCluster
          Kubeconfig Sync to 1Password ===\"\necho \"VCluster: $VCLUSTER_NAME\"\necho
          \"1Password Item: $OP_ITEM_NAME\"\necho \"Vault: $OP_VAULT\"\n\nOP_CONNECT_HOST_CLEAN=$(printf
          '%s' \"$OP_CONNECT_HOST\" | tr -d '\\r\\n')\nOP_CONNECT_TOKEN_CLEAN=$(printf
          '%s' \"$OP_CONNECT_TOKEN\" | tr -d '\\r\\n')\nAPI_BASE=\"${OP_CONNECT_HOST_CLEAN%/}/v1\"\nAUTH_HEADER=\"Authorization:
          Bearer ${OP_CONNECT_TOKEN_CLEAN}\"\n\nVAULT_ID=\"${OP_VAULT:-}\"\nVAULT_ID=$(printf
          '%s' \"$VAULT_ID\" | tr -d '\\r\\n')\nif [ -z \"$VAULT_ID\" ]; then\n\tVAULT_ID=$(curl
          -fsS -H \"$AUTH_HEADER\" \"$API_BASE/vaults\" | jq -r --arg name \"homelab\"
          '.[] | select(.name==$name) | .id' | head -n1)\nfi\nVAULT_ID=$(printf '%s'
          \"$VAULT_ID\" | tr -d '\\r\\n')\nif [ -z \"$VAULT_ID\" ]; then\n\techo \"Vault
          not found: homelab\"\n\texit 1\nfi\n\n# Read kubeconfig from secret\nKUBECONFIG_CONTENT=$(cat
          /kubeconfig/config)\n\n# Build ArgoCD cluster config\nARGOCD_CONFIG=$(cat
          <<EOF\n{\n  \"tlsClientConfig\": {\n    \"insecure\": false\n  }\n}\nEOF\n)\n\n#
          Check if item exists\necho \"Checking if item exists...\"\nITEM_SEARCH=$(curl
          -fsS -X POST \"$API_BASE/vaults/$VAULT_ID/items\" \\\n\t-H \"$AUTH_HEADER\"
          \\\n  -H \"Content-Type: application/json\" \\\n  -d \"{\\\"title\\\":\\\"$OP_ITEM_NAME\\\"}\"
          || echo \"{}\")\n\nITEM_ID=$(echo \"$ITEM_SEARCH\" | grep -o '\"id\":\"[^\"]*'
          | head -1 | cut -d'\"' -f4 || echo \"\")\n\nif [ -z \"$ITEM_ID\" ]; then\n
          \ echo \"Creating new 1Password item...\"\n\tRESPONSE=$(curl -fsS -X POST
          \"$API_BASE/vaults/$VAULT_ID/items\" \\\n\t\t-H \"$AUTH_HEADER\" \\\n    -H
          \"Content-Type: application/json\" \\\n    -d \"{\n      \\\"title\\\":
          \\\"$OP_ITEM_NAME\\\",\n      \\\"category\\\": \\\"SERVER\\\",\n      \\\"tags\\\":
          [\\\"vcluster\\\", \\\"kubeconfig\\\", \\\"$ARGOCD_ENVIRONMENT\\\"],\n      \\\"fields\\\":
          [\n        {\n          \\\"id\\\": \\\"kubeconfig\\\",\n          \\\"type\\\":
          \\\"CONCEALED\\\",\n          \\\"label\\\": \\\"kubeconfig\\\",\n          \\\"value\\\":
          $(echo \\\"$KUBECONFIG_CONTENT\\\" | jq -Rs .)\n        },\n        {\n
          \         \\\"id\\\": \\\"argocd-name\\\",\n          \\\"type\\\": \\\"STRING\\\",\n
          \         \\\"label\\\": \\\"argocd-name\\\",\n          \\\"value\\\":
          \\\"$VCLUSTER_NAME.$BASE_DOMAIN_SANITIZED\\\"\n        },\n        {\n          \\\"id\\\":
          \\\"argocd-server\\\",\n          \\\"type\\\": \\\"STRING\\\",\n          \\\"label\\\":
          \\\"argocd-server\\\",\n          \\\"value\\\": \\\"$EXTERNAL_SERVER_URL\\\"\n
          \       },\n        {\n          \\\"id\\\": \\\"argocd-config\\\",\n          \\\"type\\\":
          \\\"CONCEALED\\\",\n          \\\"label\\\": \\\"argocd-config\\\",\n          \\\"value\\\":
          $(echo \\\"$ARGOCD_CONFIG\\\" | jq -Rc .)\n        }\n      ]\n    }\")\n
          \ ITEM_ID=$(echo \"$RESPONSE\" | grep -o '\"id\":\"[^\"]*' | head -1 | cut
          -d'\"' -f4)\n\tif [ -z \"$ITEM_ID\" ]; then\n\t\techo \"Failed to create
          1Password item: $OP_ITEM_NAME\"\n\t\texit 1\n\tfi\n  echo \"Created item
          with ID: $ITEM_ID\"\nelse\n  echo \"Updating existing item ID: $ITEM_ID\"\n\tcurl
          -fsS -X PATCH \"$API_BASE/vaults/$VAULT_ID/items/$ITEM_ID\" \\\n\t\t-H \"$AUTH_HEADER\"
          \\\n    -H \"Content-Type: application/json\" \\\n    -d \"{\n      \\\"fields\\\":
          [\n        {\n          \\\"id\\\": \\\"kubeconfig\\\",\n          \\\"value\\\":
          $(echo \\\"$KUBECONFIG_CONTENT\\\" | jq -Rs .)\n        },\n        {\n
          \         \\\"id\\\": \\\"argocd-name\\\",\n          \\\"value\\\": \\\"$VCLUSTER_NAME.$BASE_DOMAIN_SANITIZED\\\"\n
          \       },\n        {\n          \\\"id\\\": \\\"argocd-server\\\",\n          \\\"value\\\":
          \\\"$EXTERNAL_SERVER_URL\\\"\n        },\n        {\n          \\\"id\\\":
          \\\"argocd-config\\\",\n          \\\"value\\\": $(echo \\\"$ARGOCD_CONFIG\\\"
          | jq -Rc .)\n        }\n      ]\n    }\"\nfi\n\necho \"âœ“ Kubeconfig synced
          to 1Password successfully\""
        env:
        - name: OP_CONNECT_HOST
          value: https://connect.integratn.tech
        - name: OP_CONNECT_TOKEN
          valueFrom:
            secretKeyRef:
              key: token
              name: vcluster-test-onepassword-token
        - name: OP_VAULT
          valueFrom:
            secretKeyRef:
              key: vault
              name: vcluster-test-onepassword-token
        - name: VCLUSTER_NAME
          value: test
        - name: OP_ITEM_NAME
          value: vcluster-test-kubeconfig
        - name: BASE_DOMAIN
          value: integratn.tech
        - name: BASE_DOMAIN_SANITIZED
          value: integratn-tech
        - name: EXTERNAL_SERVER_URL
          value: https://test.integratn.tech:443
        - name: ARGOCD_ENVIRONMENT
          value: development
        image: alpine:3.20
        name: sync-to-onepassword
        volumeMounts:
        - mountPath: /kubeconfig
          name: kubeconfig
          readOnly: true
      initContainers:
      - command:
        - sh
        - -c
        - |-
          echo "Waiting for secret vc-test to exist..."
          until [ -f /kubeconfig/config ]; do
            echo "Kubeconfig not found yet, sleeping..."
            sleep 5
          done
          echo "Kubeconfig found!"
        image: busybox:1.36
        name: wait-for-kubeconfig
        volumeMounts:
        - mountPath: /kubeconfig
          name: kubeconfig
      restartPolicy: OnFailure
      serviceAccountName: test-kubeconfig-sync
      volumes:
      - name: kubeconfig
        secret:
          optional: false
          secretName: vc-test
  ttlSecondsAfterFinished: 600
