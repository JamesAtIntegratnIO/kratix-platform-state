---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: media-etcd-ca
  namespace: vcluster-media
  labels:
    app.kubernetes.io/name: etcd-ca
    app.kubernetes.io/instance: media
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: vcluster-orchestrator-v2
    kratix.io/resource-name: media
spec:
  isCA: true
  commonName: media-etcd-ca
  secretName: media-etcd-ca
  privateKey:
    algorithm: RSA
    size: 2048
  issuerRef:
    name: media-etcd-selfsigned
    kind: Issuer
    group: cert-manager.io
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: media-etcd-selfsigned
  namespace: vcluster-media
  labels:
    app.kubernetes.io/name: etcd-issuer
    app.kubernetes.io/instance: media
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: vcluster-orchestrator-v2
    kratix.io/resource-name: media
spec:
  selfSigned: {}
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: media-etcd-ca
  namespace: vcluster-media
  labels:
    app.kubernetes.io/name: etcd-ca-issuer
    app.kubernetes.io/instance: media
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: vcluster-orchestrator-v2
    kratix.io/resource-name: media
spec:
  ca:
    secretName: media-etcd-ca
---
apiVersion: batch/v1
kind: Job
metadata:
  name: media-etcd-certs-merge
  namespace: vcluster-media
  labels:
    app.kubernetes.io/name: etcd-certs-job
    app.kubernetes.io/instance: media
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: vcluster-orchestrator-v2
    kratix.io/resource-name: media
spec:
  template:
    metadata:
      labels:
        app: etcd-certs-merge
    spec:
      restartPolicy: OnFailure
      serviceAccountName: vc-media
      containers:
      - name: merge-certs
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Waiting for certificates to be ready..."
          
          # Wait for CA cert
          until kubectl get secret media-etcd-ca -n vcluster-media 2>/dev/null; do
            echo "Waiting for CA certificate..."
            sleep 2
          done
          
          # Wait for server cert
          until kubectl get secret media-etcd-server -n vcluster-media 2>/dev/null; do
            echo "Waiting for server certificate..."
            sleep 2
          done
          
          # Wait for peer cert
          until kubectl get secret media-etcd-peer -n vcluster-media 2>/dev/null; do
            echo "Waiting for peer certificate..."
            sleep 2
          done
          
          echo "All certificates ready, merging..."
          
          # Extract certs
          CA_CRT=$(kubectl get secret media-etcd-ca -n vcluster-media -o jsonpath='{.data.tls\.crt}')
          SERVER_CRT=$(kubectl get secret media-etcd-server -n vcluster-media -o jsonpath='{.data.tls\.crt}')
          SERVER_KEY=$(kubectl get secret media-etcd-server -n vcluster-media -o jsonpath='{.data.tls\.key}')
          PEER_CRT=$(kubectl get secret media-etcd-peer -n vcluster-media -o jsonpath='{.data.tls\.crt}')
          PEER_KEY=$(kubectl get secret media-etcd-peer -n vcluster-media -o jsonpath='{.data.tls\.key}')
          
          # Create merged secret
          kubectl create secret generic media-certs -n vcluster-media \
            --from-literal=etcd-ca.crt="$(echo $CA_CRT | base64 -d)" \
            --from-literal=etcd-server.crt="$(echo $SERVER_CRT | base64 -d)" \
            --from-literal=etcd-server.key="$(echo $SERVER_KEY | base64 -d)" \
            --from-literal=etcd-peer.crt="$(echo $PEER_CRT | base64 -d)" \
            --from-literal=etcd-peer.key="$(echo $PEER_KEY | base64 -d)" \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "Certificate merge complete!"
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: media-etcd-server
  namespace: vcluster-media
  labels:
    app.kubernetes.io/name: etcd-server-cert
    app.kubernetes.io/instance: media
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: vcluster-orchestrator-v2
    kratix.io/resource-name: media
spec:
  secretName: media-etcd-server
  commonName: media-etcd
  dnsNames:
    - media-etcd
    - media-etcd.vcluster-media
    - media-etcd.vcluster-media.svc
    - media-etcd.vcluster-media.svc.cluster.local
    - media-etcd-headless
    - media-etcd-headless.vcluster-media
    - media-etcd-headless.vcluster-media.svc
    - media-etcd-headless.vcluster-media.svc.cluster.local
    - media-etcd-0
    - media-etcd-0.media-etcd-headless.vcluster-media
    - media-etcd-0.media-etcd-headless.vcluster-media.svc
    - media-etcd-0.media-etcd-headless.vcluster-media.svc.cluster.local
    - media-etcd-1
    - media-etcd-1.media-etcd-headless.vcluster-media
    - media-etcd-1.media-etcd-headless.vcluster-media.svc
    - media-etcd-1.media-etcd-headless.vcluster-media.svc.cluster.local
    - media-etcd-2
    - media-etcd-2.media-etcd-headless.vcluster-media
    - media-etcd-2.media-etcd-headless.vcluster-media.svc
    - media-etcd-2.media-etcd-headless.vcluster-media.svc.cluster.local
    - localhost
  ipAddresses:
    - 127.0.0.1
  privateKey:
    algorithm: RSA
    size: 2048
  usages:
    - server auth
    - client auth
  issuerRef:
    name: media-etcd-ca
    kind: Issuer
    group: cert-manager.io
  secretTemplate:
    labels:
      app.kubernetes.io/name: etcd-server-cert
      app.kubernetes.io/instance: media
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: media-etcd-peer
  namespace: vcluster-media
  labels:
    app.kubernetes.io/name: etcd-peer-cert
    app.kubernetes.io/instance: media
    app.kubernetes.io/managed-by: kratix
    kratix.io/promise-name: vcluster-orchestrator-v2
    kratix.io/resource-name: media
spec:
  secretName: media-etcd-peer
  commonName: media-etcd
  dnsNames:
    - media-etcd
    - media-etcd.vcluster-media
    - media-etcd.vcluster-media.svc
    - media-etcd.vcluster-media.svc.cluster.local
    - media-etcd-headless
    - media-etcd-headless.vcluster-media
    - media-etcd-headless.vcluster-media.svc
    - media-etcd-headless.vcluster-media.svc.cluster.local
    - media-etcd-0
    - media-etcd-0.media-etcd-headless.vcluster-media
    - media-etcd-0.media-etcd-headless.vcluster-media.svc
    - media-etcd-0.media-etcd-headless.vcluster-media.svc.cluster.local
    - media-etcd-1
    - media-etcd-1.media-etcd-headless.vcluster-media
    - media-etcd-1.media-etcd-headless.vcluster-media.svc
    - media-etcd-1.media-etcd-headless.vcluster-media.svc.cluster.local
    - media-etcd-2
    - media-etcd-2.media-etcd-headless.vcluster-media
    - media-etcd-2.media-etcd-headless.vcluster-media.svc
    - media-etcd-2.media-etcd-headless.vcluster-media.svc.cluster.local
  privateKey:
    algorithm: RSA
    size: 2048
  usages:
    - server auth
    - client auth
  issuerRef:
    name: media-etcd-ca
    kind: Issuer
    group: cert-manager.io
  secretTemplate:
    labels:
      app.kubernetes.io/name: etcd-peer-cert
      app.kubernetes.io/instance: media

